{
  "hash": "61eb6890378cd4664b5a9853c706e7d0",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"AE 14: Chicago taxi classification\"\nsubtitle: \"Suggested answers\"\ncategories: \n  - Application exercise\n  - Answers\n---\n\n::: callout-important\nThese are suggested answers.\nThis document should be used as reference only, it's not designed to be an exhaustive key.\n:::\n\nIn this application exercise, we will\n\n-   Split our data into testing and training\n-   Fit logistic regression regression models to testing data to classify outcomes\n-   Evaluate performance of models on testing data\n\nWe will use **tidyverse** and **tidymodels** for data exploration and modeling,\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tidymodels)\n```\n:::\n\n\nand the `chicago_taxi` dataset introduced in the lecture.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchicago_taxi <- read_csv(\"data/chicago-taxi.csv\") |>\n  mutate(\n    tip = fct_relevel(tip, \"no\", \"yes\"),\n    local = fct_relevel(local, \"no\", \"yes\"),\n    dow = fct_relevel(dow, \"Mon\", \"Tue\", \"Wed\", \"Thu\", \"Fri\", \"Sat\", \"Sun\"),\n    month = fct_relevel(month, \"Jan\", \"Feb\", \"Mar\", \"Apr\")\n  )\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 2000 Columns: 7\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (5): tip, company, local, dow, month\ndbl (2): distance, hour\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n\nRemember from the lecture that the `chicago_taxi` dataset contains information on whether a trip resulted in a tip (`yes`) or not (`no`) as well as numerical and categorical features of the trip.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglimpse(chicago_taxi)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 2,000\nColumns: 7\n$ tip      <fct> no, no, no, no, no, no, no, no, no, no, no, no, no, no, no, n…\n$ distance <dbl> 0.40, 0.96, 1.07, 1.13, 10.81, 3.60, 1.08, 0.85, 17.92, 0.00,…\n$ company  <chr> \"other\", \"Taxicab Insurance Agency Llc\", \"Sun Taxi\", \"other\",…\n$ local    <fct> yes, no, no, no, no, no, yes, no, no, yes, yes, no, no, no, n…\n$ dow      <fct> Fri, Mon, Fri, Sat, Sat, Wed, Wed, Tue, Tue, Sun, Fri, Fri, F…\n$ month    <fct> Mar, Apr, Feb, Feb, Apr, Mar, Mar, Mar, Jan, Apr, Apr, Feb, M…\n$ hour     <dbl> 17, 8, 15, 14, 14, 12, 13, 8, 20, 16, 20, 8, 15, 15, 12, 0, 1…\n```\n\n\n:::\n:::\n\n\n# Spending your data\n\nSplit your data into testing and training in a reproducible manner and display the split object.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1234)\nchicago_taxi_split <- initial_split(chicago_taxi)\nchicago_taxi_split\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n<Training/Testing/Total>\n<1500/500/2000>\n```\n\n\n:::\n:::\n\n\nWhat percent of the original `chicago_taxi` data is allocated to training and what percent to testing?\nCompare your response to your neighbor's.\nAre the percentages roughly consistent?\nWhat determines this in the `initial_split()`?\nHow would the code need to be updated to allocate 80% of the data to training and the remaining 20% to testing?\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# training percentage\n7500 / 10000\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.75\n```\n\n\n:::\n\n```{.r .cell-code}\n# testing percentage\n2500 / 10000\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.25\n```\n\n\n:::\n:::\n\n\n75% of the data is allocated to training and the remaining 25% to testing.\nThis is because the `prop` argument in `initial_split()` is `3/4` by default.\nThe code would need to be updated as follows for a 80%/20% split:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# split 80-20\nset.seed(123456)\ninitial_split(chicago_taxi, prop = 0.8)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n<Training/Testing/Total>\n<1600/400/2000>\n```\n\n\n:::\n:::\n\n\nLet's stick with the default split and save our testing and training data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchicago_taxi_train <- training(chicago_taxi_split)\nchicago_taxi_test <- testing(chicago_taxi_split)\n```\n:::\n\n\n# Model 1: Custom choice of predictors\n\n## Fit\n\nFit a model for classifying trips as tipped or not based on a subset of predictors of your choice.\nName the model `chicago_taxi_custom_fit` and display a tidy output of the model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchicago_taxi_custom_fit <- logistic_reg() |>\n  fit(\n    tip ~ hour + distance + local + dow,\n    data = chicago_taxi_train\n  )\ntidy(chicago_taxi_custom_fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10 × 5\n   term        estimate std.error statistic   p.value\n   <chr>          <dbl>     <dbl>     <dbl>     <dbl>\n 1 (Intercept) -0.0380    0.239      -0.159 0.874    \n 2 hour         0.00505   0.0128      0.395 0.693    \n 3 distance     0.0343    0.00872     3.93  0.0000848\n 4 localyes    -0.336     0.136      -2.47  0.0134   \n 5 dowTue       0.210     0.197       1.07  0.286    \n 6 dowWed       0.380     0.199       1.91  0.0563   \n 7 dowThu       0.284     0.195       1.46  0.144    \n 8 dowFri       0.380     0.194       1.95  0.0506   \n 9 dowSat       0.203     0.236       0.862 0.388    \n10 dowSun       0.638     0.246       2.59  0.00963  \n```\n\n\n:::\n:::\n\n\n## Predict\n\nPredict for the testing data using this model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchicago_taxi_custom_aug <- augment(\n  chicago_taxi_custom_fit,\n  new_data = chicago_taxi_test\n)\nchicago_taxi_custom_aug\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 500 × 10\n   .pred_class .pred_no .pred_yes tip   distance company local dow   month  hour\n   <fct>          <dbl>     <dbl> <fct>    <dbl> <chr>   <fct> <fct> <fct> <dbl>\n 1 yes            0.474     0.526 no        0.4  other   yes   Fri   Mar      17\n 2 yes            0.388     0.612 no        1.07 Sun Ta… no    Fri   Feb      15\n 3 yes            0.353     0.647 no       10.8  Sun Ta… no    Sat   Apr      14\n 4 yes            0.473     0.527 no        1.08 Flash … yes   Wed   Mar      13\n 5 yes            0.440     0.560 no        0.85 Taxica… no    Tue   Mar       8\n 6 yes            0.292     0.708 no       17.9  City S… no    Tue   Jan      20\n 7 yes            0.370     0.630 no        4.4  City S… no    Fri   Feb       8\n 8 yes            0.340     0.660 no       10    Taxi A… no    Thu   Apr      15\n 9 yes            0.467     0.533 no        1    other   yes   Fri   Mar      18\n10 yes            0.386     0.614 no        6.26 Flash … no    Tue   Apr      15\n# ℹ 490 more rows\n```\n\n\n:::\n:::\n\n\n## Evaluate\n\nCalculate the false positive and false negative rates for the testing data using this model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchicago_taxi_custom_aug |>\n  count(.pred_class, tip) |>\n  arrange(tip) |>\n  group_by(tip) |>\n  mutate(\n    p = round(n / sum(n), 2),\n    decision = case_when(\n      .pred_class == \"yes\" & tip == \"yes\" ~ \"True positive\",\n      .pred_class == \"yes\" & tip == \"no\" ~ \"False positive\",\n      .pred_class == \"no\" & tip == \"yes\" ~ \"False negative\",\n      .pred_class == \"no\" & tip == \"no\" ~ \"True negative\"\n    )\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 5\n# Groups:   tip [2]\n  .pred_class tip       n     p decision      \n  <fct>       <fct> <int> <dbl> <chr>         \n1 no          no       15  0.08 True negative \n2 yes         no      184  0.92 False positive\n3 no          yes      28  0.09 False negative\n4 yes         yes     273  0.91 True positive \n```\n\n\n:::\n:::\n\n\nAnother commonly used display of this information is a confusion matrix.\nCreate this using the `conf_mat()` function.\nYou will need to review the documentation for the function to determine how to use it.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nconf_mat(\n  chicago_taxi_custom_aug,\n  truth = tip,\n  estimate = .pred_class\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          Truth\nPrediction  no yes\n       no   15  28\n       yes 184 273\n```\n\n\n:::\n:::\n\n\n## Sensitivity, specificity, ROC curve\n\nCalculate sensitivity and specificity and draw the ROC curve.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchicago_taxi_custom_roc <- roc_curve(\n  chicago_taxi_custom_aug,\n  truth = tip,\n  .pred_yes,\n  event_level = \"second\"\n)\nchicago_taxi_custom_roc\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 492 × 3\n   .threshold specificity sensitivity\n        <dbl>       <dbl>       <dbl>\n 1   -Inf         0             1    \n 2      0.421     0             1    \n 3      0.425     0             0.997\n 4      0.427     0.00503       0.993\n 5      0.428     0.0101        0.993\n 6      0.430     0.0151        0.993\n 7      0.431     0.0201        0.993\n 8      0.432     0.0251        0.993\n 9      0.432     0.0302        0.993\n10      0.435     0.0302        0.990\n# ℹ 482 more rows\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot(chicago_taxi_custom_roc, aes(x = 1 - specificity, y = sensitivity)) +\n  geom_path() +\n  geom_abline(lty = 3) +\n  coord_equal()\n```\n\n::: {.cell-output-display}\n![](ae-14-chicago-taxi-classification-A_files/figure-html/forested-custom-roc-1.png){width=672}\n:::\n:::\n\n\n# Model 2: All predictors\n\n## Fit\n\nFit a model for classifying plots as forested or not based on all predictors available.\nName the model `forested_full_fit` and display a tidy output of the model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchicago_taxi_full_fit <- logistic_reg() |>\n  fit(tip ~ ., data = chicago_taxi_train)\ntidy(chicago_taxi_full_fit)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 19 × 5\n   term                                estimate std.error statistic  p.value\n   <chr>                                  <dbl>     <dbl>     <dbl>    <dbl>\n 1 (Intercept)                          0.0718    0.337       0.213 0.831   \n 2 distance                             0.0321    0.00888     3.62  0.000295\n 3 companyCity Service                 -0.0411    0.264      -0.156 0.876   \n 4 companyFlash Cab                    -0.781     0.261      -2.99  0.00276 \n 5 companyother                        -0.0866    0.237      -0.365 0.715   \n 6 companySun Taxi                      0.0537    0.264       0.204 0.839   \n 7 companyTaxi Affiliation Services    -0.291     0.247      -1.18  0.239   \n 8 companyTaxicab Insurance Agency Llc -0.142     0.262      -0.542 0.588   \n 9 localyes                            -0.348     0.138      -2.53  0.0115  \n10 dowTue                               0.197     0.199       0.992 0.321   \n11 dowWed                               0.361     0.201       1.80  0.0725  \n12 dowThu                               0.256     0.197       1.30  0.193   \n13 dowFri                               0.316     0.197       1.60  0.109   \n14 dowSat                               0.170     0.238       0.715 0.474   \n15 dowSun                               0.570     0.250       2.29  0.0223  \n16 monthFeb                             0.122     0.176       0.694 0.487   \n17 monthMar                             0.145     0.161       0.901 0.368   \n18 monthApr                             0.185     0.162       1.14  0.256   \n19 hour                                 0.00485   0.0129      0.375 0.707   \n```\n\n\n:::\n:::\n\n\n## Predict\n\nPredict for the testing data using this model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchicago_taxi_full_aug <- augment(\n  chicago_taxi_full_fit,\n  new_data = chicago_taxi_test\n)\nchicago_taxi_full_aug\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 500 × 10\n   .pred_class .pred_no .pred_yes tip   distance company local dow   month  hour\n   <fct>          <dbl>     <dbl> <fct>    <dbl> <chr>   <fct> <fct> <fct> <dbl>\n 1 yes            0.452     0.548 no        0.4  other   yes   Fri   Mar      17\n 2 yes            0.338     0.662 no        1.07 Sun Ta… no    Fri   Feb      15\n 3 yes            0.290     0.710 no       10.8  Sun Ta… no    Sat   Apr      14\n 4 no             0.611     0.389 no        1.08 Flash … yes   Wed   Mar      13\n 5 yes            0.416     0.584 no        0.85 Taxica… no    Tue   Mar       8\n 6 yes            0.289     0.711 no       17.9  City S… no    Tue   Jan      20\n 7 yes            0.343     0.657 no        4.4  City S… no    Fri   Feb       8\n 8 yes            0.351     0.649 no       10    Taxi A… no    Thu   Apr      15\n 9 yes            0.446     0.554 no        1    other   yes   Fri   Mar      18\n10 no             0.513     0.487 no        6.26 Flash … no    Tue   Apr      15\n# ℹ 490 more rows\n```\n\n\n:::\n:::\n\n\n## Evaluate\n\nCalculate the false positive and false negative rates for the testing data using this model.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchicago_taxi_full_aug |>\n  count(.pred_class, tip) |>\n  arrange(tip) |>\n  group_by(tip) |>\n  mutate(\n    p = round(n / sum(n), 2),\n    decision = case_when(\n      .pred_class == \"yes\" & tip == \"yes\" ~ \"True positive\",\n      .pred_class == \"yes\" & tip == \"no\" ~ \"False positive\",\n      .pred_class == \"no\" & tip == \"yes\" ~ \"False negative\",\n      .pred_class == \"no\" & tip == \"no\" ~ \"True negative\"\n    )\n  )\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 4 × 5\n# Groups:   tip [2]\n  .pred_class tip       n     p decision      \n  <fct>       <fct> <int> <dbl> <chr>         \n1 no          no       41  0.21 True negative \n2 yes         no      158  0.79 False positive\n3 no          yes      37  0.12 False negative\n4 yes         yes     264  0.88 True positive \n```\n\n\n:::\n:::\n\n\n## Sensitivity, specificity, ROC curve\n\nCalculate sensitivity and specificity and draw the ROC curve.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchicago_taxi_full_roc <- roc_curve(\n  chicago_taxi_full_aug,\n  truth = tip,\n  .pred_yes,\n  event_level = \"second\"\n)\nchicago_taxi_full_roc\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 500 × 3\n   .threshold specificity sensitivity\n        <dbl>       <dbl>       <dbl>\n 1   -Inf         0             1    \n 2      0.274     0             1    \n 3      0.298     0.00503       1    \n 4      0.311     0.0101        1    \n 5      0.347     0.0151        1    \n 6      0.348     0.0151        0.997\n 7      0.355     0.0151        0.993\n 8      0.356     0.0151        0.990\n 9      0.357     0.0201        0.990\n10      0.368     0.0201        0.987\n# ℹ 490 more rows\n```\n\n\n:::\n\n```{.r .cell-code}\nggplot(chicago_taxi_full_roc, aes(x = 1 - specificity, y = sensitivity)) +\n  geom_path() +\n  geom_abline(lty = 3) +\n  coord_equal()\n```\n\n::: {.cell-output-display}\n![](ae-14-chicago-taxi-classification-A_files/figure-html/forested-full-roc-1.png){width=672}\n:::\n:::\n\n\n# Model 1 vs. Model 2\n\nPlot both ROC curves and articulate how you would use them to compare these models. Also calculate the areas under the two curves.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nchicago_taxi_custom_roc <- chicago_taxi_custom_roc |>\n  mutate(model = \"Custom\")\nchicago_taxi_full_roc <- chicago_taxi_full_roc |>\n  mutate(model = \"Full\")\n\nbind_rows(\n  chicago_taxi_custom_roc,\n  chicago_taxi_full_roc\n) |>\n  ggplot(aes(x = 1 - specificity, y = sensitivity, color = model)) +\n  geom_path() +\n  geom_abline(lty = 3) +\n  coord_equal()\n```\n\n::: {.cell-output-display}\n![](ae-14-chicago-taxi-classification-A_files/figure-html/compare-1.png){width=672}\n:::\n\n```{.r .cell-code}\nroc_auc(\n  chicago_taxi_custom_aug,\n  truth = tip,\n  .pred_yes,\n  event_level = \"second\"\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 roc_auc binary         0.517\n```\n\n\n:::\n\n```{.r .cell-code}\nroc_auc(\n  chicago_taxi_full_aug,\n  truth = tip,\n  .pred_yes,\n  event_level = \"second\"\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 3\n  .metric .estimator .estimate\n  <chr>   <chr>          <dbl>\n1 roc_auc binary         0.568\n```\n\n\n:::\n:::\n\n",
    "supporting": [
      "ae-14-chicago-taxi-classification-A_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}